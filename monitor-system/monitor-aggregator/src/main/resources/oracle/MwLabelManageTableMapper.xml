<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.mw.monitor.labelManage.dao.MwLabelManageTableDao">

    <!-- 新增标签信息 -->
    <insert id="insert" parameterType="cn.mw.monitor.labelManage.api.param.AddUpdateLabelManageParam">
        <selectKey keyProperty="labelId" order="BEFORE" resultType="java.lang.Integer">
            select ${TBSNAME}.SEQ_MW_LABELMANAGE_TABLE.NEXTVAL as "labelId" from DUAL
        </selectKey>
        INSERT INTO ${TBSNAME}."mw_labelmanage_table"
        (
        "label_id",
        <if test="labelName != null and labelName != ''">
            "label_name",
        </if>
        <if test="inputFormat != null">
            "input_format",
        </if>
        <if test="chooseAdd != null">
            "choose_add",
        </if>
        <if test="earlyWarning != null">
            "early_warning",
        </if>
        <if test="screen != null">
            "screen",
        </if>
        <if test="report != null">
            "report",
        </if>
        <if test="isRequired != null">
            "is_required",
        </if>
        <if test="dropdownValue != null and dropdownValue != ''">
            "dropdown_value",
        </if>
        <if test="labelCode != null and labelCode != ''">
            "label_code",
        </if>
        <if test="deleteRestrict != null">
            "delete_restrict",
        </if>
        <if test="enable != null and enable != ''">
            "enable",
        </if>
        <if test="creator != null and creator != ''">
            "creator",
        </if>
        "create_date",
        <if test="modifier != null and modifier != ''">
            "modifier",
        </if>
        "modification_date"
        ) VALUES (
        #{labelId,jdbcType=INTEGER},
        <if test="labelName != null and labelName != ''">
            #{labelName,jdbcType=VARCHAR},
        </if>
        <if test="inputFormat != null">
            #{inputFormat,jdbcType=INTEGER},
        </if>
        <if test="chooseAdd != null">
            <if test="chooseAdd == true">
                1,
            </if>
            <if test="chooseAdd == false">
                0,
            </if>
        </if>
        <if test="earlyWarning != null">
            <if test="earlyWarning == true">
                1,
            </if>
            <if test="earlyWarning == false">
                0,
            </if>
        </if>
        <if test="screen != null">
            <if test="screen == true">
                1,
            </if>
            <if test="screen == false">
                0,
            </if>
        </if>
        <if test="report != null">
            <if test="report == true">
                1,
            </if>
            <if test="report == false">
                0,
            </if>
        </if>
        <if test="isRequired != null">
            <if test="isRequired == true">
                1,
            </if>
            <if test="isRequired == false">
                0,
            </if>
        </if>
        <if test="dropdownValue != null and dropdownValue != ''">
            #{dropdownValue,jdbcType=VARCHAR},
        </if>
        <if test="labelCode != null and labelCode != ''">
            #{labelCode,jdbcType=VARCHAR},
        </if>
        <if test="deleteRestrict != null">
            <if test="deleteRestrict == true">
                1,
            </if>
            <if test="deleteRestrict == false">
                0,
            </if>
        </if>
        <if test="enable != null and enable != ''">
            #{enable,jdbcType=VARCHAR},
        </if>
        <if test="creator != null and creator != ''">
            #{creator,jdbcType=VARCHAR},
        </if>
        SYSDATE,
        <if test="modifier != null and modifier != ''">
            #{modifier,jdbcType=VARCHAR},
        </if>
        SYSDATE
        )
    </insert>

    <!-- 新增标签和资产类型关联关系 -->
    <insert id="createAssetsTypeLabelMapper">
        INSERT INTO ${TBSNAME}."mw_label_assetstype_mapper"
        (
        "id",
        "assets_type_id",
        "label_id",
        "update_time"
        )
        select ${TBSNAME}.SEQ_MW_LABEL_ASSETSTYPE_MAPPER.NEXTVAL as id,t.* from(
        <foreach collection="list" item="list" separator="union all">
            (select
            #{list.assetsTypeId} as "assets_type_id",
            #{list.labelId} as "label_id",
            SYSDATE as "update_time"
            from dual
            )
        </foreach>
        ) t
    </insert>

    <insert id="createModuleLabelMapper">
        INSERT INTO ${TBSNAME}."mw_label_module_mapper"
        (
        "id",
        "module_id",
        "label_id",
        "update_time"
        )
        select ${TBSNAME}.SEQ_MW_LABEL_MODULE_MAPPER.NEXTVAL as id,t.* from(
        <foreach collection="list" item="list" separator="union all">
            (select
            #{list.moduleId} as "module_id",
            #{list.labelId} as "label_id",
            SYSDATE
            from dual
            )
        </foreach>
        ) t
    </insert>


    <!-- 根据标签id查询标签名称 -->
    <select id="selectLabelMsgById" resultType="java.util.Map">
        SELECT
            "label_name" as "labelName",
            "dropdown_value" as "dropdownValue"
        FROM ${TBSNAME}."mw_labelmanage_table"
        WHERE "label_id" = #{labelId}
    </select>

    <!-- 删除标签信息 -->
    <update id="delete">
        UPDATE ${TBSNAME}."mw_labelmanage_table"
        SET "modifier" = #{modifier},
        "modification_date" = SYSDATE,
        "delete_flag" = 1
        WHERE "delete_flag" = 0
        AND "label_id" IN (
        <foreach collection="labelIds" item="list" separator=",">
            #{list}
        </foreach>
        )
    </update>

    <!-- 删除标签和资产类型关联关系 -->
    <update id="deleteAssetsTypeLableMapper">
        UPDATE ${TBSNAME}."mw_label_assetstype_mapper"
        SET "update_time" = SYSDATE,
        "delete_flag" = 1
        WHERE "delete_flag" = 0
        AND "label_id" IN
        (
        <foreach collection="labelIds" item="list" separator=",">
            #{list}
        </foreach>
        )
    </update>

    <!-- 删除标签和模型类型关联关系 -->
    <update id="deleteModelLabelapper">
        UPDATE ${TBSNAME}."mw_label_module_mapper"
        SET "update_time" = SYSDATE,
        "delete_flag" = 1
        WHERE "delete_flag" = 0
        AND "label_id" IN
        (
        <foreach collection="labelIds" item="list" separator=",">
            #{list}
        </foreach>
        )
    </update>

    <!-- 变更标签状态 -->
    <update id="updateState" parameterType="cn.mw.monitor.labelManage.api.param.UpdateLabelStateParam">
        UPDATE ${TBSNAME}."mw_labelmanage_table"
        SET "enable" = #{enable},
            "modifier" = #{modifier},
            "modification_date" = SYSDATE
        WHERE "label_id" = #{labelId}
    </update>

    <!-- 更新标签信息 -->
    <update id="update" parameterType="cn.mw.monitor.labelManage.api.param.AddUpdateLabelManageParam">
        UPDATE ${TBSNAME}."mw_labelmanage_table"
        SET
        <if test="labelName != null and labelName != ''">
            "label_name" = #{labelName},
        </if>
        <if test="inputFormat != null">
            "input_format" = #{inputFormat},
        </if>
        <if test="chooseAdd != null">
            "choose_add" = #{chooseAdd},
        </if>
        <if test="earlyWarning != null">
            "early_warning" = #{earlyWarning},
        </if>
        <if test="screen != null">
            "screen" = #{screen},
        </if>
        <if test="report != null">
            "report" = #{report},
        </if>
        <if test="isRequired != null">
            "is_required" = #{isRequired},
        </if>
        <choose>
            <when test="dropdownValue == null">
                "dropdown_value" = null,
            </when>
            <otherwise>
                "dropdown_value" = #{dropdownValue},
            </otherwise>
        </choose>
        <if test="deleteRestrict != null">
            "delete_restrict" = #{deleteRestrict},
        </if>
        <if test="enable != null and enable != ''">
            "enable" = #{enable},
        </if>
        <if test="modifier != null and modifier != ''">
            "modifier" = #{modifier},
        </if>
        "modification_date" = SYSDATE
        WHERE "label_id" = #{labelId}
    </update>


    <!-- 分页查询标签列表信息 -->
    <select id="selectList" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT
        "label_id",
        "label_name",
        "input_format",
        (case "input_format"
        when 1 then '文本框'
        when 2 then '时间框'
        when 3 then '下拉框'
        when 4 then '其他'
        end) "input_format_name",
        "choose_add",
        "early_warning",
        "screen",
        "report",
        "is_required" as "isRequired",
        "dropdown_value",
        "delete_restrict",
        "enable",
        "creator",
        "create_date",
        "modifier",
        "modification_date"
        FROM ${TBSNAME}."mw_labelmanage_table"
        WHERE "delete_flag" = 0
        <if test="fuzzyQuery != null and fuzzyQuery != ''">
            and
            (
            NVL( "label_name", #{fuzzyQuery} ) ||
            NVL( "creator",  #{fuzzyQuery} ) ||
            NVL( "modifier",  #{fuzzyQuery} )
            ) LIKE '%'|| #{fuzzyQuery}||'%'
            ORDER BY
            ( CASE WHEN INSTR( "label_name",  #{fuzzyQuery} ) > 0 THEN 0 ELSE 1 END ),
            ( CASE WHEN INSTR(  "creator",  #{fuzzyQuery} ) > 0 THEN 0 ELSE 1 END ),
            ( CASE WHEN INSTR( "modifier",  #{fuzzyQuery} ) > 0 THEN 0 ELSE 1 END )
        </if>
        <if test="labelName != null and labelName != ''">
            AND "label_name" LIKE '%'|| #{labelName}||'%'
        </if>
        <if test="inputFormat != null">
            AND "input_format" = #{inputFormat}
        </if>
        <if test="enable != null and enable != ''">
            AND "enable" = #{enable}
        </if>
        <if test="isRequired != null ">
            AND "is_required" = #{isRequired}
        </if>
        <if test="creator != null and creator != ''">
            AND "creator" LIKE '%'|| #{creator}|| '%'
        </if>
        <if test="modifier != null and creator != ''">
            AND "modifier" LIKE '%'|| #{modifier}|| '%'
        </if>
        <if test="createDateStart != null">
            AND <![CDATA[ "create_date" >= #{createDateStart}]]>
        </if>
        <if test="createDateEnd != null">
            AND <![CDATA[ "create_date" <= #{createDateEnd}]]>
        </if>
        <if test="modificationDateStart != null">
            AND <![CDATA[ "modification_date" >= #{modificationDateStart} ]]>
        </if>
        <if test="modificationDateEnd != null">
            AND <![CDATA[ "modification_date" <= #{modificationDateEnd} ]]>
        </if>
    </select>

    <resultMap id="BaseResultMap" type="cn.mw.monitor.labelManage.dto.MwLabelManageDTO">
        <id column="label_id" jdbcType="INTEGER" property="labelId"/>
        <result column="label_name" jdbcType="VARCHAR" property="labelName"/>
        <result column="input_format" jdbcType="INTEGER" property="inputFormat"/>
        <result column="input_format_name" jdbcType="VARCHAR" property="inputFormatName"/>
        <result column="choose_add" jdbcType="BIT" property="chooseAdd"/>
        <result column="early_warning" jdbcType="BIT" property="earlyWarning"/>
        <result column="screen" jdbcType="BIT" property="screen"/>
        <result column="report" jdbcType="BIT" property="report"/>
        <result column="isRequired" jdbcType="BIT" property="isRequired"/>
        <result column="label_code" jdbcType="VARCHAR" property="labelCode"/>
        <result column="dropdown_value" jdbcType="VARCHAR" property="dropdownValue"/>
        <result column="delete_restrict" jdbcType="BIT" property="deleteRestrict"/>
        <result column="enable" jdbcType="VARCHAR" property="enable"/>
        <result column="creator" jdbcType="VARCHAR" property="creator"/>
        <result column="create_date" jdbcType="TIMESTAMP" property="createDate"/>
        <result column="modifier" jdbcType="VARCHAR" property="modifier"/>
        <result column="modification_date" jdbcType="TIMESTAMP" property="modificatioDate"/>
        <collection property="assetsType" ofType="cn.mw.monitor.labelManage.dto.MwAssetsTypeDTO"
                    select="selectAssetsType" column="label_id"></collection>
        <collection property="moduleType" ofType="cn.mw.monitor.labelManage.dto.MwModuleTypeDTO"
                    select="selectModuleType" column="label_id"></collection>
        <collection property="dropdownTable" ofType="cn.mw.monitor.dropDown.dto.MwDropdownDTO"
                    select="cn.mw.monitor.dropDown.dao.MwDropdownTableDao.selectByCode"
                    column="label_code"></collection>
    </resultMap>


    <!-- 根据标签id查询标签关联资产类型信息 -->
    <select id="selectAssetsType" resultType="cn.mw.monitor.labelManage.dto.MwAssetsTypeDTO">
        SELECT
        t1."id" as "id",
        t1."type_name" as "typeName"
        FROM ${TBSNAME}."mw_assetssubtype_table" t1
        WHERE "pid" = 0
        <if test="labelId != null and labelId !=''">
            AND t1."id" IN
            (
            SELECT
            t2."assets_type_id"
            FROM ${TBSNAME}."mw_label_assetstype_mapper" t2
            WHERE t2."delete_flag" = 0
            AND t2."label_id" = #{labelId}
            )
        </if>
    </select>

    <select id="selectModuleType" resultType="cn.mw.monitor.labelManage.dto.MwModuleTypeDTO">
        SELECT
        t1."id" as "id",
        t1."module_type" as "moduleType"
        FROM ${TBSNAME}."mw_label_module_base" t1
        WHERE 1=1
        <if test="labelId != null and labelId !=''">
            AND t1."id" IN
            (
            SELECT
            t2."module_id"
            FROM ${TBSNAME}."mw_label_module_mapper" t2
            WHERE t2."delete_flag" = 0
            AND t2."label_id" = #{labelId}
            )
        </if>
    </select>

    <!-- 根据标签ID查询标签信息 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT
            "label_id",
            "label_name",
            "input_format",
            "choose_add",
            "early_warning",
            "screen",
            "report",
            "is_required" as "isRequired",
            "dropdown_value",
            "label_code",
            "delete_restrict",
            "enable"
        FROM ${TBSNAME}."mw_labelmanage_table"
        WHERE "label_id" = #{labelId}
    </select>
    <select id="getLabelListByAssetsTypeId" resultType="cn.mw.monitor.labelManage.dto.MwLabelAssetsTypeDTO">
        SELECT  t1."label_id" as "labelId",t1."label_name" as "labelName","input_format" as "inputFormat","dropdown_value" as "dropdownValue" from ${TBSNAME}."mw_labelmanage_table" t1 left join ${TBSNAME}."mw_label_assetstype_mapper" t2
        on t1."label_id"=t2."label_id" where t1."delete_flag"=0 and t2."assets_type_id"=#{assetsTypeId}
    </select>
    <select id="getIdListByLabel" resultType="java.lang.String" parameterType="cn.mw.monitor.service.label.model.MWCommonLabel">
        select t2."link_id" from ${TBSNAME}."mw_labelmanage_table" t1 left join ${TBSNAME}."mw_label_link_mapper" t2 on t1."label_id"=t2."label_id"
        left join ${TBSNAME}."mw_network_link" t3 on t2."link_id"=t3."link_id"
        left join ${TBSNAME}."mw_dropdown_table" t4
        on t1."dropdown_value"=t4."drop_code" and t4."drop_key"=t2."tagboard" where t3."delete_flag"=0 and
        t2."label_id"=#{labelId}
        <choose>
            <when test="inputFormat == 2">
                and t2."date_tagboard" between #{labelDateStart} and #{labelDateEnd}
            </when>
            <when test="inputFormat == 3">
                and t4."drop_Key" = #{dropKey}
            </when>
            <otherwise>and t2."tagboard" like
                '%'||#{labelValue}||'%'
            </otherwise>
        </choose>
    </select>
    <select id="getAssetsIdByLabel" resultType="java.lang.String">
        select "type_id" from ${TBSNAME}."mw_label_mapper" where 1=1
        <include refid="criteria"></include> union
        select "type_id" from ${TBSNAME}."mw_label_drop_mapper" where 1=1
        <include refid="criteria"></include> union
        select "type_id" from ${TBSNAME}."mw_label_date_mapper" where 1=1
        <include refid="criteria"></include>
    </select>
    <sql id="criteria">
        <if test="filterLabelIds !=null">
            and "label_id" IN
            <foreach collection="filterLabelIds" item="item" index="index" open="(" separator="," close=")">
                #{item.value}
            </foreach>
        </if>
        <if test="moduleType !=null and moduleType!='' ">
            and "module_type"=#{moduleType}
        </if>
    </sql>



    <!--
    <insert id="insertBatch" parameterType="java.util.List">
        insert into mw_labelmanage_table
        (
            label_name,
            input_format,
            choose_add,
            early_warning,
            screen,
            report,
            dropdown_value,
            delete_restrict,
            enable,
            creator,
            create_date
        ) values
        <foreach collection="list" item="insertList" separator=",">
        (
            #{insertList.labelName},
            #{insertList.inputFormat},
            #{insertList.chooseAdd},
            #{insertList.earlyWarning},
            #{insertList.screen},
            #{insertList.report},
            #{insertList.dropdownValue},
            #{insertList.deleteRestrict},
            #{insertList.enable},
            #{insertList.creator},
            SYSDATE
        )
        </foreach>
    </insert>

    <update id="updateBatch" parameterType="java.util.List">
    <foreach collection="list" item ="updateList" separator=",">
        update mw_labelmanage_table
        set label_name = #{updateList.labelName},
            input_format = #{updateList.inputFormat},
            choose_add = #{updateList.chooseAdd},
            early_warning = #{updateList.earlyWarning},
            screen = #{updateList.screen},
            report = #{updateList.report},
            dropdown_value = #{updateList.dropdownValue},
            delete_restrict = #{updateList.deleteRestrict},
            enable = #{updateList.enable}
        where id = #{updateList.id}
    </foreach>
    </update>

      (#{insertList.labelId},#{insertList.moduleId},
            #{insertList.tagboard},#{insertList.dateTagboard})
     -->


    <insert id="createLabelMapper" parameterType="java.util.List">
        insert into ${TBSNAME}."mw_label_mapper"
        ("id","label_id","type_id","module_type","tagboard")
        select ${TBSNAME}.SEQ_MW_LABEL_MAPPER.NEXTVAL as id,t.* from (
        <foreach collection="list" item="insertList" separator="union all">
            (select
             #{insertList.labelId} as "label_id",
             #{insertList.typeId} as "type_id",
             #{insertList.moduleType} as "module_type",
             #{insertList.tagboard} as "tagboard"
            from dual)
        </foreach>
        ) t
    </insert>

    <insert id="createLabelDateMapper" parameterType="java.util.List">
        insert into ${TBSNAME}."mw_label_date_mapper"
        ("id","label_id","type_id","module_type","date_tagboard")
        select ${TBSNAME}.SEQ_MW_LABEL_DATE_MAPPER.NEXTVAL as id,t.* from (
        <foreach collection="list" item="insertList" separator="union all">
            (select
                #{insertList.labelId} as "label_id",
                #{insertList.typeId} as "type_id",
                #{insertList.moduleType} as "module_type",
                #{insertList.dateTagboard} as "date_tagboard"
            from dual)
        </foreach>
        ) t
    </insert>

    <insert id="createLabelDropMapper" parameterType="java.util.List">
        insert into ${TBSNAME}."mw_label_drop_mapper"
        ("id","label_id","type_id","module_type","drop_tagboard")
        select ${TBSNAME}.SEQ_MW_LABEL_DATE_MAPPER.NEXTVAL as id,t.* from (
        <foreach collection="list" item="insertList" separator="union all">
            (select
                #{insertList.labelId} as "label_id",
                #{insertList.typeId} as "type_id",
                #{insertList.moduleType} as "module_type",
                #{insertList.dropTagboard} as "drop_tagboard"
            from dual)
        </foreach>
        ) t
    </insert>


    <select id="selectLabelBrowse" resultType="cn.mw.monitor.service.assets.model.MwAllLabelDTO"
            parameterType="cn.mw.monitor.service.label.model.QueryLabelParam">
        select distinct
        t1."label_id" as "id",
        t1."label_code" as "prop",
        t1."label_name" as "label",
        t1."input_format" as "inputFormat",
        t1."choose_add" as "chooseAdd",
        t1."is_required" as "isRequired"
        from ${TBSNAME}."mw_labelmanage_table" t1
        left join ${TBSNAME}."mw_label_assetstype_mapper" t2 on t1."label_id" = t2."label_id"
        left join ${TBSNAME}."mw_label_module_mapper" t3 on t1."label_id" = t3."label_id"
        where t1."delete_flag" = 0 and t2."delete_flag"=0 and t3."delete_flag"=0 and t1."enable"='ACTIVE'
        <if test="assetsTypeId != null and assetsTypeId != 0">
            and t2."assets_type_id" = #{assetsTypeId}
        </if>
        <if test="moduleId != null and moduleId != 0">
            and t3."module_id" = #{moduleId}
        </if>
        <if test="labelName != null and labelName != ''">
            and t1."label_name" LIKE '%'||#{labelName}||'%'
        </if>
        <if test="isRequired != null ">
            and t1."is_required" = #{isRequired}
        </if>
    </select>

    <select id="selectLabelBrowseByList" resultType="cn.mw.monitor.service.assets.model.MwAllLabelDTO"
            parameterType="cn.mw.monitor.service.label.model.QueryLabelParam">
        SELECT
            "label_id" as "id",
            "label_name" as "label",
            "input_format" as "inputFormat",
            "label_code" as "prop",
            "choose_add" as "chooseAdd",
            "is_required" as "isRequired"
        FROM
            ${TBSNAME}."mw_labelmanage_table"
        WHERE
            "label_id" IN (
            select distinct
            "id"
            from (
            <foreach collection="assetsTypeList" item="listId" separator="union ALL">
                select distinct
                t1."label_id" as "id",
                t1."label_name" as "label",
                t1."input_format" as "inputFormat",
                t1."label_code" as "prop",
                t1."choose_add" as "chooseAdd",
                t1."is_required" as "isRequired"
                from ${TBSNAME}."mw_labelmanage_table" t1
                left join ${TBSNAME}."mw_label_assetstype_mapper" t2 on t1."label_id" = t2."label_id"
                left join ${TBSNAME}."mw_label_module_mapper" t3 on t1."label_id" = t3."label_id"
                where t1."delete_flag" = 0 and t2."delete_flag"=0 and t3."delete_flag"=0 and t1."enable"='ACTIVE'
                and t2."assets_type_id" = #{listId}
                <if test="moduleId != null and moduleId != 0">
                    and t3."module_id" = #{moduleId}
                </if>
                <if test="labelName != null and labelName != ''">
                    and t1."label_name" LIKE '%'||#{labelName}||'%'
                </if>
            </foreach>
            ) a
            GROUP BY a."id"
            <if test="assetsTypeList != null and assetsTypeList.size > 1">
                HAVING count(a."id") >1
            </if>
        )
    </select>
    <select id="selectLabelBoard" resultType="cn.mw.monitor.service.assets.model.MwAssetsLabelDTO">
        SELECT distinct
        t1."label_id" as "id",
        t1."label_name" as "labelName",
        "input_format" as "inputFormat",
        "tagboard",
        t1."is_required" as "isRequired",
        t2."type_id" as "typeId"
        FROM
        ${TBSNAME}."mw_labelmanage_table" t1
        right JOIN ${TBSNAME}."mw_label_mapper" t2 ON t1."label_id" = t2."label_id"
        WHERE
        t2."module_type" = #{moduleType}
        <if test="typeId != null and typeId !=''">
            AND t2."type_id" = #{typeId}
        </if>
    </select>

    <select id="selectLabelDateBoard" resultType="cn.mw.monitor.service.assets.model.MwAssetsLabelDTO">
        SELECT distinct
        t1."label_id" as "id",
         t1."label_name" as "labelName",
        "input_format" as "inputFormat",
        "date_tagboard" as "dateTagboard",
        t1."is_required" as "isRequired",
        t2."type_id" as "typeId"
        FROM
        ${TBSNAME}."mw_labelmanage_table" t1
        right JOIN ${TBSNAME}."mw_label_date_mapper" t2 ON t1."label_id" = t2."label_id"
        WHERE
        t2."module_type" = #{moduleType}
        <if test="typeId != null and typeId !=''">
            AND t2."type_id" = #{typeId}
        </if>
    </select>

    <select id="selectLabelDropBoard" resultType="cn.mw.monitor.service.assets.model.MwAssetsLabelDTO">
        SELECT distinct
        t1."label_id" as "id",
        t1."label_name" as "labelName",
        t1."input_format" as "inputFormat",
        t2."drop_tagboard" as "dropTagboard",
        t3."drop_value" as "dropValue",
        t3."drop_code" as "prop",
        t3."drop_key" as "dropKey",
        t1."is_required" as "isRequired",
        t2."type_id" as "typeId"
        FROM
        ${TBSNAME}."mw_labelmanage_table" t1
        right join ${TBSNAME}."mw_label_drop_mapper" t2 ON t1."label_id" = t2."label_id"
        left join ${TBSNAME}."mw_dropdown_table" t3 on t2."drop_tagboard"=t3."drop_id"
        WHERE
        t2."module_type" = #{moduleType}
        and t3."delete_flag"=0
        <if test="typeId != null and typeId !=''">
            AND t2."type_id" = #{typeId}
        </if>

    </select>

    <delete id="deleteLabelBoard">
        delete from ${TBSNAME}."mw_label_mapper" where "type_id" = #{typeId} and "module_type" = #{moduleType}
    </delete>

    <delete id="deleteLabelDateBoard">
        delete from ${TBSNAME}."mw_label_date_mapper" where "type_id" = #{typeId} and "module_type" = #{moduleType}
    </delete>

    <delete id="deleteLabelDropBoard">
        delete from ${TBSNAME}."mw_label_drop_mapper" where "type_id" = #{typeId} and "module_type" = #{moduleType}
    </delete>
    <delete id="deleteLabelBoards">
        delete from ${TBSNAME}."mw_label_mapper" where "module_type" = #{moduleType} and "type_id" in
        <foreach collection="list" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
    </delete>

    <delete id="deleteLabelDateBoards">
        delete from ${TBSNAME}."mw_label_date_mapper" where "module_type" = #{moduleType} and "type_id" in
        <foreach collection="list" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
    </delete>

    <delete id="deleteLabelDropBoards">
        delete from ${TBSNAME}."mw_label_drop_mapper" where "module_type" = #{moduleType} and "type_id" in
        <foreach collection="list" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
    </delete>


    <select id="getTypeIdsByTagboard" parameterType="java.util.List" resultType="java.lang.String">
        select t."type_id" from (
<!--        <choose>-->
<!--            <when test="operation == 'union'">-->
<!--                <foreach collection="tagboardList" item="list" separator="union">-->
<!--                    select distinct b.type_id from mw_labelmanage_table a-->
<!--                    left join ${list.tableName} b on a.label_id=b.label_id-->
<!--                    where b.module_type=#{list.modelType}-->
<!--                    and-->
<!--                    a.label_id=#{list.labelId}-->
<!--                    <choose>-->
<!--                        <when test="list.inputFormat=='1'">-->
<!--                        and b.tagboard like CONCAT('%', #{list.tagboard}, '%')-->
<!--                    </when>-->
<!--                        <when test="list.inputFormat=='2'">-->
<!--                            and b.date_tagboard  between  #{list.startdateTagboard,jdbcType=DATE} and #{list.enddateTagboard,jdbcType=DATE}-->
<!--                        </when>-->
<!--                        <when test="list.inputFormat=='3'">-->
<!--                            and b.drop_tagboard = #{list.dropTagboard}-->
<!--                        </when>-->
<!--                    </choose>-->
<!--                </foreach>-->
<!--            </when>-->
<!--            <otherwise>-->
                <foreach collection="tagboardList" item="list" separator="intersect">
                    select distinct b."type_id" from ${TBSNAME}."mw_labelmanage_table" a
                    left join '"'||${list.tableName}'"' b on a."label_id"=b."label_id"
                    where b."module_type"=#{list.modelType}
                    and
                    a."label_id"=#{list.labelId}
                    <choose>
                    <when test="list.inputFormat==1">
                        and b."tagboard" like '%'|| #{list.tagboard}|| '%'
                    </when>
                    <when test="list.inputFormat==2">
                        and b."date_tagboard"  between  #{list.startdateTagboard} and #{list.enddateTagboard}
                    </when>
                    <when test="list.inputFormat==3">
                        and b."drop_tagboard" = #{list.dropTagboard}
                    </when>
                    </choose>
                </foreach>
<!--            </otherwise>-->
<!--        </choose>-->


        ) t
    </select>
    <select id="getCountByLabelId" resultType="java.lang.Integer">
        select count(0) from ${TBSNAME}."${tableName}" where "label_id"=#{labelId}
    </select>
    <select id="getLabelIdsByAssetsId" resultType="java.lang.String">
        SELECT "label_id" FROM ${TBSNAME}."mw_label_mapper" where "module_type"=#{moduleType} and "type_id"=#{typeId}
        UNION
        SELECT "label_id" FROM ${TBSNAME}."mw_label_date_mapper" where "module_type"=#{moduleType} and "type_id"=#{typeId}
        UNION
        SELECT "label_id" FROM ${TBSNAME}."mw_label_drop_mapper" where "module_type"=#{moduleType} and "type_id"=#{typeId}
    </select>
    <select id="getLabelsByAssetsId" resultType="java.util.Map">
        SELECT "label_id" as "labelId","tagboard" as "value" FROM ${TBSNAME}."mw_label_mapper" where "module_type"=#{moduleType} and "type_id"=#{typeId}
        UNION
        SELECT "label_id" as "labelId","date_tagboard" as "value" FROM ${TBSNAME}."mw_label_date_mapper" where "module_type"=#{moduleType} and "type_id"=#{typeId}
        UNION
        SELECT "label_id" as "labelId",t2."drop_value" as "value" FROM ${TBSNAME}."mw_label_drop_mapper" t1
        left join ${TBSNAME}."mw_dropdown_table"  t2 on t1."drop_tagboard"=t2."drop_id"
        where "module_type"=#{moduleType} and "type_id"=#{typeId}
    </select>
    <select id="getLableData" resultType="cn.mw.monitor.labelManage.api.param.AddUpdateLabelManageParam">
         select * from ${TBSNAME}."mw_labelmanage_table" where "label_id" = #{labelId}
    </select>
    <select id="getTextTypeIdAndModule" resultType="java.util.Map">
         SELECT DISTINCT t2."type_id" as "typeId",t2."module_type" as "moduleType"
         FROM
            ${TBSNAME}."mw_labelmanage_table" t1
        right JOIN ${TBSNAME}."mw_label_mapper" t2 ON t1."label_id" = t2."label_id"
        WHERE
            t2."label_id" = #{labelId}
    </select>
    <select id="getDropDownTypeIdAndModule" resultType="java.util.Map">
        SELECT DISTINCT
	        t2."type_id" as "typeId",
	        t2."module_type" as "moduleType"
        FROM
	        ${TBSNAME}."mw_labelmanage_table" t1
	    RIGHT JOIN ${TBSNAME}."mw_label_drop_mapper" t2 ON t1."label_id" = t2."label_id"
	    LEFT JOIN ${TBSNAME}."mw_dropdown_table" t3 ON t2."drop_tagboard" = t3."drop_id"
        WHERE
	        t3."delete_flag" = 0
	    AND t2."label_id" = #{labelId}
    </select>
    <select id="getDateTypeIdAndModule" resultType="java.util.Map">
        SELECT DISTINCT
	        t2."type_id" as "typeId",
	        t2."module_type" as "moduleType"
        FROM
	        ${TBSNAME}."mw_labelmanage_table" t1
	    RIGHT JOIN ${TBSNAME}."mw_label_date_mapper" t2 ON t1."label_id" = t2."label_id"
        WHERE
	        t2."label_id" = #{labelId}
    </select>
    <insert id="insertDropdownTables" parameterType="cn.mw.monitor.labelManage.dto.LabelEditConvertDto"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO ${TBSNAME}."mw_dropdown_table"
        (
        "drop_id",
        "drop_code",
        "drop_key",
        "drop_value",
        "update_time"
        )
        select ${TBSNAME}.SEQ_MW_DROPDOWN_TABLE.NEXTVAL as drop_id,t.* from (
        <foreach collection="list" item="list" separator="union all">
            (select
                #{list.dropCode} as "drop_code",
                #{list.dropKey} as "drop_key",
                #{list.dropValue} as "drop_value",
                SYSDATE as "update_time"
            from dual
            )
        </foreach>
        ) t
    </insert>
    <insert id="insetLabelDropMapper" parameterType="cn.mw.monitor.labelManage.dto.LabelEditConvertDto">
         INSERT INTO ${TBSNAME}."mw_label_drop_mapper"
        (
        "id",
        "label_id",
        "type_id",
        "module_type",
        "drop_tagboard"
        )
        select ${TBSNAME}.SEQ_MW_LABEL_DROP_MAPPER.NEXTVAL as id,t.* from (
        <foreach collection="list" item="list" separator="union all">
            (select
            #{list.labelId} as "label_id",
            #{list.typeId} as "type_id",
            #{list.moduleType} as "module_type",
            #{list.id} as "drop_tagboard"
            from dual
            )
        </foreach>
        )
    </insert>


    <delete id="deleteLabelTextType">
        delete from ${TBSNAME}."mw_label_drop_mapper" where "label_id" = #{labelId}
    </delete>
    <delete id="deleteDropdownTables" parameterType="java.lang.String">
        delete from ${TBSNAME}."mw_dropdown_table" where "drop_code" = #{labelCode}
    </delete>


    <select id="selectAssociatedDropId" resultType="java.lang.Integer">
       select "drop_tagboard" as "dropId" from ${TBSNAME}."mw_label_drop_mapper" where "drop_tagboard" in (
        <foreach collection="list" item="list" separator=",">
           #{list}
        </foreach>
       )
    </select>

    <select id="selectDropDownId" resultType="java.util.Map" parameterType="java.lang.String">
        select "drop_id" as "dropId","drop_key" as "dropKey","drop_value" as "dropValue" from ${TBSNAME}."mw_dropdown_table" where "drop_code" = #{labelCode} and "delete_flag" = 0
    </select>

    <update id="updateDropDownData" parameterType="java.util.List">
        <foreach collection="list" item="list" separator=";">
            update ${TBSNAME}."mw_dropdown_table" set
                "drop_key" = #{list.dropKey},
                "drop_value" = #{list.dropValue},
                "update_time" = SYSDATE
            where "drop_id" =  #{list.dropId}
        </foreach>
    </update>
    <insert id="insertDropDownData" parameterType="java.util.List">
        insert into ${TBSNAME}."mw_dropdown_table"
        (
        "drop_id",
        "drop_code",
        "drop_key",
        "drop_value",
        "update_time"
        )
        select ${TBSNAME}.SEQ_MW_DROPDOWN_TABLE.NEXTVAL as id,t.* from (
        <foreach collection="list" item="list" separator=",">
            (select
            #{list.dropCode} as "drop_code",
            #{list.dropKey} as "drop_key",
            #{list.dropValue} as "drop_value",
            SYSDATE as "update_time"
            from dual
            )
        </foreach>
        )
    </insert>

    <delete id="deleteDropDownData" parameterType="java.util.Set">
        update ${TBSNAME}."mw_dropdown_table" set
        "delete_flag" = 1,
        "update_time" = SYSDATE
        where "drop_id" in (
        <foreach collection="collection" item="item" separator=",">
             #{item}
        </foreach>
        )
    </delete>
    <select id="getLabelCode" resultType="java.lang.String">
        select "label_code" from ${TBSNAME}."mw_labelmanage_table" where "label_id" = #{labelId}
    </select>
    <select id="getDropLabelRepeatData" resultType="java.lang.Integer">
        select "drop_id" from ${TBSNAME}."mw_dropdown_table" where "delete_flag" = 0 and "drop_code" = #{labelCode} and "drop_value" = #{dropValue}
        <if test="dropId != null and dropId != ''">
            and "drop_id" != #{dropId}
        </if>
    </select>

    <select id="getDropDownKeyMaxValue" resultType="java.lang.Integer">
        select max("drop_key") as "dropKey" from ${TBSNAME}."mw_dropdown_table" where "drop_code" = #{labelCode}
    </select>
    <select id="fuzzyQueryLabelAllFiledData" resultType="java.util.Map">
        SELECT
            a."label_name" as "labelName",
            a."creator",
            a."modifier"
            FROM
        ${TBSNAME}."mw_labelmanage_table" a
        where a."delete_flag" = 0
    </select>
    <select id="fuzzyQueryLabelNames" resultType="java.lang.String">
        select distinct "label_name" from ${TBSNAME}."mw_labelmanage_table" where "delete_flag" = 0
    </select>


    <select id="selectOldLabel" resultType="cn.mw.monitor.dropDown.model.MwDropdownTable">
     SELECT * from ${TBSNAME}."mw_dropdown_table" WHERE "drop_value"||"drop_code" in
    (SELECT "cell" FROM (select "drop_value"||"drop_code" as "cell" from ${TBSNAME}."mw_dropdown_table" WHERE "delete_flag" =0 ) a GROUP BY "cell" HAVING count("cell") >1) and  "delete_flag" =0 ORDER BY "drop_value" asc
      </select>


    <update id="updateById" parameterType="java.util.List">
        update ${TBSNAME}."mw_label_drop_mapper" set
        "drop_tagboard" = #{updateId}
        where "drop_tagboard" in (
        <foreach collection="delete" item="item" separator=",">
            #{item}
        </foreach>
        )
    </update>

    <delete id="updateDeleteById">
        update ${TBSNAME}."mw_dropdown_table" set
        "delete_flag" = 0
        where "drop_id" = #{id}
    </delete>
    <select id="selectLabelBoards" resultType="cn.mw.monitor.service.assets.model.MwAssetsLabelDTO">
        SELECT distinct
        t1."label_id" as "id",
        t1."label_name" as "labelName",
        "input_format" as "inputFormat",
        "tagboard",
        t1."is_required" as "isRequired",
        t2."type_id" as "typeId"
        FROM
        ${TBSNAME}."mw_labelmanage_table" t1
        right JOIN ${TBSNAME}."mw_label_mapper" t2 ON t1."label_id" = t2."label_id"
        WHERE
        t2."module_type" = #{moduleType}
        <if test="typeIds != null and typeIds.size > 0">
            AND t2."type_id" in (
            <foreach collection="typeIds" item="item" separator=",">
                #{item}
            </foreach>
            )
        </if>
    </select>
    <select id="selectLabelDateBoards" resultType="cn.mw.monitor.service.assets.model.MwAssetsLabelDTO">
        SELECT distinct
        t1."label_id" as "id",
        t1."label_name" as "labelName",
        "input_format" as "inputFormat",
        "date_tagboard" as "dateTagboard",
        t1."is_required" as "isRequired",
        t2."type_id" as "typeId"
        FROM
        ${TBSNAME}."mw_labelmanage_table" t1
        right JOIN ${TBSNAME}."mw_label_date_mapper" t2 ON t1."label_id" = t2."label_id"
        WHERE
        t2."module_type" = #{moduleType}
        <if test="typeIds != null and typeIds.size > 0">
            AND t2."type_id" in (
            <foreach collection="typeIds" item="item" separator=",">
                #{item}
            </foreach>
            )
        </if>
    </select>
    <select id="selectLabelDropBoards" resultType="cn.mw.monitor.service.assets.model.MwAssetsLabelDTO">
        SELECT distinct
        t1."label_id" as "id",
        t1."label_name" as "labelName",
        t1."input_format" as "inputFormat",
        t2."drop_tagboard" as "dropTagboard",
        t3."drop_value" as "dropValue",
        t3."drop_code" as "prop",
        t3."drop_key" as "dropKey",
        t1."is_required" "isRequired",
        t2."type_id" as "typeId"
        FROM
        ${TBSNAME}."mw_labelmanage_table" t1
        right join ${TBSNAME}."mw_label_drop_mapper" t2 ON t1."label_id" = t2."label_id"
        left join ${TBSNAME}."mw_dropdown_table" t3 on t2."drop_tagboard"=t3."drop_id"
        WHERE
        t2."module_type" = #{moduleType}
        and t3."delete_flag"=0
        <if test="typeIds != null and typeIds.size > 0">
            AND t2."type_id" in (
            <foreach collection="typeIds" item="item" separator=",">
                #{item}
            </foreach>
            )
        </if>
    </select>
</mapper>
